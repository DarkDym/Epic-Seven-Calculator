(function(n,p){var l=BPLR.Util;n.$bp.A9=BPLR.Abstract.extend({bidding:!1,allowScroll:!1,previousUrls:[],timeout:3E3,apsWindow:null,midrollBidding:!1,midrollLastBiddedCuepoint:null,pub_id:null,video_server:null,vmap:!1,dont_use_dfp:!1,init:function b(a,c){b.base.call(this,a,c);a.config.a9_timeout&&(this.timeout=parseInt(a.config.a9_timeout));this.player.config.A9&&this.player.config.A9.vmap&&(this.vmap=!0);this.player.config.A9&&this.player.config.A9.dont_use_dfp&&(this.dont_use_dfp=!0);a.config.A9&&
(this.pub_id=this.player.config.A9.pub_id,this.adUnits=this.generateAdUnits(a.config.A9));a.config.AdSchedule&&(this.adUnits=this.generateNewAdUnits(a.config.AdSchedule));0!=this.adUnits.length&&-1==l.getEmbededUrl().indexOf("#BPLRNoA9")&&a.config.monetize?(this.schainData=l.getSchain(this.player,BPLR.Util.$f(this,this.onSellersLoad)),this.waitingForSellersFile=!1===this.schainData,this.player.add(["nextVideo","skipped"],this.$f(this.onNextVideo)),this.player.addOnce("playCalledDuringBidding",this.$f(this.onPlayCalledDuringBidding)),
l.isMobilePlatform()&&a.config.autoplay&&(BPLR.log("A9 set muted for mobile"),a.muted(!0)),this.adUnits.some(function(d){return"midroll"==d.type})&&0==this.player.config.auto_skip_at&&(BPLR.log("A9 prepare to bid for midrolls during playback"),this.player.add("timeupdate",this.$f(this.onTimeupdate))),this.prepare()):(BPLR.log("A9 not valid unit config found, returning..."),this.allowScroll=!0)},prepare:function(){if(!this.waitingForSellersFile){BPLR.log("A9 initializing iframe, apstag exists on page?",
"undefined"!=typeof apstag);var a=p.createElement("iframe");p.body.appendChild(a);a.setAttribute("id","bp-a9-apstag-holder-"+Date.now());a.style.display="none";a.style.border="0";a.style.width="0px";a.style.height="0px";a.addEventListener("load",function(c){this.apsWindow=a.contentWindow;this.loadAndInitialize()}.bind(this));a.contentWindow.document.open();a.contentWindow.document.write("<body><script>(function(){try{if (typeof window.parent.__tcfapi=='function'){window.__tcfapi=window.parent.__tcfapi;}else if(typeof window.top.__tcfapi=='function'){window.__tcfapi=window.top.__tcfapi;}}catch(e){let frame=window,cmpFrame;const cmpCallbacks={};while(frame){try{if(frame.frames['__tcfapiLocator']){cmpFrame=frame;break;}}catch(ignore){}if(frame===window.top)break;frame=frame.parent;}window.__tcfapi=function(cmd,version,callback,arg){if(!cmpFrame){callback({msg: 'CMP not found'},false);}else{const callId=Math.random()+'';const msg={__tcfapiCall:{command:cmd,parameter:arg,version:version,callId:callId,},};cmpCallbacks[callId]=callback;cmpFrame.postMessage(msg,'*');}};function postMessageHandler(event){let json={};try{json=typeof event.data==='string'?JSON.parse(event.data):event.data;}catch(ignore){}const payload=json.__tcfapiReturn;if(payload){if(typeof cmpCallbacks[payload.callId]==='function'){cmpCallbacks[payload.callId](payload.returnValue,payload.success);cmpCallbacks[payload.callId]=null;}}}window.addEventListener('message',postMessageHandler,false);}}());\x3c/script></body>");
a.contentWindow.document.close()}},loadAndInitialize:function(){!function(c,b,d,g,k,f,e){b[c]||(b[c]={init:function(){b[c]._Q.push(["i",arguments])},fetchBids:function(){b[c]._Q.push(["f",arguments])},setDisplayBids:function(){},targetingKeys:function(){return[]},_Q:[]},f=d.createElement(g),f.async=!0,f.src=k,e=d.getElementsByTagName(g)[0],e.parentNode.insertBefore(f,e))}("apstag",this.apsWindow,this.apsWindow.document,"script","//c.amazon-adsystem.com/aax2/apstag.js");var a={pubID:this.pub_id,videoAdServer:this.video_server||
"DFP",bidTimeout:this.timeout,deals:!0};this.schainData&&this.schainData.config&&(a.schain=this.schainData.config,0<a.schain.nodes.length&&(delete a.schain.nodes[0].domain,delete a.schain.nodes[0].name));BPLR.log("A9 initializing apstag",a);this.apsWindow.apstag.init(a);this.a9Ready()},a9Ready:function(){BPLR.log("A9 ready, bid_preload",this.player.config.bid_preload);this.a9ReadyFired=!0;(this.player.config.bid_preload||this.playCalled)&&this.runBidding()},onPlayCalledDuringBidding:function(){this.playCalled=
!0;!this.player.config.bid_preload&&this.a9ReadyFired&&this.runBidding()},runBidding:function(a){var c=this.player,b=this;a=a&&a[0]?a:this.adUnits;!this.bidding&&this.apsWindow&&(c.adsManager&&c.adsManager.checkOffsetAndFrequency()?(BPLR.log("A9 runBidding bidding",this.bidding,"player.isReady",this.player.isReady,"adUnits",this.adUnits),0==a.length?this.playback():this.player.config.wait_tcf_api&&!this.consentChecked?BPLR.Util.checkConsent(this.player,function(d){d.api?(BPLR.log("A9 consent exists, proceed to bidding"),
b.consentChecked=!0,b.runBidding()):(BPLR.log("A9 no consent, skip bidding"),b.playback())}):(this.bidding=!0,this.biddingFinished=!1,setTimeout(this.$f(function(){BPLR.log("A9 timeout occurred");this.allBidsFinished()}),this.timeout),this.apsWindow.apstag.fetchBids({slots:this.generateBids(),timeout:this.timeout},function(d){BPLR.log("A9 bidsBackHandler",d);b.bidsReturned(d.filter(function(g){return"video"===g.mediaType}))}))):this.playback())},bidsReturned:function(a){if(!this.biddingFinished){if(this.vmap){var c,
b,d="";a.forEach(function(k){var f=this.getUnitsForSlot(k.slotID);if(f){c&&"preroll"!=f[0].type||(b=f[0],c=f[0].vast_tag);var e=parseInt(this.getAdType(f[0].type))+1;f=f[0].id.replace(/^.*-/,"");0<f&&(e+=""+(parseInt(f)+1));Object.keys(k.targeting).forEach(function(h){d=0<=["amzniid","amznbid","amznp"].indexOf(h)?d+("&"+h+"_"+e+"="+k.targeting[h]):d+("&"+h+"="+k.targeting[h])})}},this);if(b){a=this.addCustParams(c,{qsParams:d});var g=a.match(/iu=(.+?)&/i);g={unitId:b.id,unitIu:g?g[1]:null};BPLR.log("A9 setting vastUrl",
a,b.id);g={adTagUrl:a,adType:"0",adTimeType:"s",overlayStartAt:null,overlayDuration:null,pod:0,source:"a9",data:g};b.ad_source_id&&(g.id=b.ad_source_id,g.sc=b.sc_id);BPLR.log("A9 setAd Object (VMAP)",g);this.player.setAd(g,!0,null,!0);this.previousUrls.push(a)}}else a.forEach(function(k){this.getUnitsForSlot(k.slotID).forEach(function(f){var e=this.dont_use_dfp?"https://aax.amazon-adsystem.com/e/dtb/vast?b="+k.targeting.amzniid+"&rnd=[timestamp]&pp="+k.targeting.amznbid:this.addCustParams(f.vast_tag,
k),h=e.match(/iu=(.+?)&/i);h={unitId:f.id,unitIu:h?h[1]:null};var m=0;-1<f.vast_tag.indexOf("wf_pos")&&(m=(m=f.vast_tag.match(/wf_pos=(\d)/i))?parseInt(m[1]):0);BPLR.log("A9 setting vastUrl",e,f.id);h={adTagUrl:e,adType:this.getAdType(f.type),adTimeType:"s",overlayStartAt:null,overlayDuration:null,pod:f.id.replace(/^.*-/,""),source:"a9",data:h};0<m&&(h.wf_pos=m);f.ad_source_id&&(h.id=f.ad_source_id,h.sc=f.sc_id);this.midrollBidding?(BPLR.log("A9 replacePrebidTag",e,"unit id",f.id,"ad object",h),this.player.Advertising.replacePrebidTag(h)):
(BPLR.log("A9 setAd Object",h),this.player.setAd(h,!0,null,!0),this.previousUrls.push(e))},this)},this);this.allBidsFinished()}},allBidsFinished:function(){this.biddingFinished?BPLR.log("A9 allBidsFinished already called..."):(BPLR.log("A9 all bids returned"),this.bidding=!1,this.biddingFinished=!0,this.midrollBidding||this.player.adsManager.checkScheduledAds(),this.playback())},getUnitsForSlot:function(a){return this.adUnits.filter(function(c){return c.slotID==a})},getAdType:function(a){return"postroll"==
a?"2":"midroll"==a?"1":"0"},addCustParams:function(a,c){c=c.qsParams||c.helpers.qsParams();var b=RegExp("[&?]cust_params=","i");c=encodeURIComponent(c.replace(/^&/,""));return a=b.test(a)?a.replace(b,"$&"+c+"%26"):a+((-1==a.indexOf("?")?"?":"&")+"cust_params="+c)},generateAdUnits:function(a){var c=[];["preroll","midroll","postroll"].forEach(function(b){a[b]&&a[b].forEach(function(d,g){d.id="bplr-"+b+"-"+(void 0!=d.pod?d.pod:g);d.type=b;d.index=g;d.mediaType="video";d.slotID=d.slot_id;d.slotID&&d.vast_tag&&
c.push(d)})});return c},generateNewAdUnits:function(a){var c=this,b=[];l.each(["preroll","midroll","postroll"],function(d){a[d]&&l.each(a[d],function(g,k){if(g.mobile||g.desktop){if(!BPLR.isMobilePlatform&&g.desktop)var f=g.desktop.adSources;else g.mobile&&(f=g.mobile.adSources);l.each(f,function(e,h){e.A9&&(e=l.merge({},e.A9),c.pub_id=e.pub_id,delete e.pub_id,e.pod=k,e.ad_source_id=e.id,e.sc_id=a.id,e.id="bplr-"+d+"-"+(void 0!=e.pod?e.pod:h),e.type=d,e.index=h,e.mediaType="video",e.slotID=e.slot_id,
e.slotID&&e.vast_tag&&b.push(e))})}})});return b},generateBids:function(){return this.adUnits.map(function(a){return{slotID:a.slotID,mediaType:a.mediaType}})},playback:function(){this.midrollBidding?this.midrollBidding=!1:this.playbackOccurred||(BPLR.log("A9 playback",this.player.config.autoplay,this.player.values.playCalled,this.playCalled),this.playbackOccurred=this.allowScroll=!0,this.player.values.playCalled||this.playCalled?this.player.play():this.player.config.autoplay&&(this.player.config.autoplayInview?
(this.player.isPlayerInView()||"BPLR.OSPlayer"==this.player.name)&&this.player.play():this.player.play()))},onTimeupdate:function(){var a=this.player,c=this.player.adsManager,b=c.getScheduledCuepoints();if(b&&b.length&&!this.bidding&&!a.getAdInProgress()&&!a.waitingForAd&&(this.midrollLastBiddedCuepoint||(this.midrollLastBiddedCuepoint=b[0]),!(1>a.currentTime()-this.midrollLastBiddedCuepoint)&&b[0]!=this.midrollLastBiddedCuepoint&&(this.midrollLastBiddedCuepoint=b[0],a=this.adUnits.filter(function(d){return"midroll"==
d.type}),0<a.length))){BPLR.log("A9 start bidding for midroll at cuepoint",this.midrollLastBiddedCuepoint);for(b=0;b<c.ads.midroll.adTags.length;b++)c.ads.midroll.adTags[b]=c.ads.midroll.adTags[b].filter(function(d){return"a9"!=d.source&&"combined"!=d.source});this.midrollBidding=!0;this.runBidding(a)}},onNextVideo:function(a){this.blockedByTimer||(this.blockedByTimer=!0,setTimeout(this.$f(function(){this.blockedByTimer=!1}),1E3),BPLR.log("A9",a.type,this.player.currentIndex,this.previousUrls,!!this.player.adsManager),
this.previousUrls=[],this.allowScroll=this.playbackOccurred=this.bidding=!1,this.midrollLastBiddedCuepoint=null,this.runBidding())},onSellersLoad:function(a,c){BPLR.log("A9 schainData",c,"success",a);this.schainData=c;this.waitingForSellersFile=!1;this.prepare()}});n.$bp.plugin("brida9",function(a,c){a=a||this;c=c||{};a.isReady?a.addChild(new n.$bp.A9(a,c)):n.$bp.Util.merge(a.config.children,{A9:{}})});BPLR.event.trigger(p,"bridpluginloaded")})(window,document);
